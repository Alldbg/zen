FROM node:10.15.0

RUN apt-get update

# popper-utils for pdfinfo
RUN apt-get install -y pdftk poppler-utils=0.48.0-2+deb9u2
RUN apt-get install -y ghostscript=9.26a~dfsg-0+deb9u5

WORKDIR /home/back

CMD (which yarn || npm i -g yarn@1.15.2) && \
    if [ "$NODE_ENV" = "production" ] || [ "$NODE_ENV" = "qa" ]; then \
        yarn install --production && \
        yarn run knex migrate:latest && \
        yarn run production; \
    else \
        yarn install && \
        yarn run knex migrate:latest && \
        yarn start; \
    fi
